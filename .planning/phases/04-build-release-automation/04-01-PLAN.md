---
phase: 04-build-release-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .goreleaser.yaml
  - .golangci.yml
  - Makefile
autonomous: true

must_haves:
  truths:
    - "GoReleaser config produces binaries named kubectl-analyze-images for linux/darwin/windows on amd64/arm64"
    - "GoReleaser injects version, commit, and date via ldflags into main.go build vars"
    - "golangci-lint config defines a reasonable set of linters for a v1.0 Go project"
    - "Makefile has lint target that runs golangci-lint and snapshot target for local goreleaser testing"
  artifacts:
    - path: ".goreleaser.yaml"
      provides: "Multi-platform release configuration for GoReleaser v2"
      contains: "version: 2"
    - path: ".golangci.yml"
      provides: "Linter configuration for golangci-lint"
      contains: "linters:"
    - path: "Makefile"
      provides: "Updated build targets including lint and snapshot"
      contains: "lint:"
  key_links:
    - from: ".goreleaser.yaml"
      to: "cmd/kubectl-analyze-images/main.go"
      via: "ldflags inject version/commit/date into main package vars"
      pattern: "main\\.version"
    - from: "Makefile"
      to: ".goreleaser.yaml"
      via: "snapshot target invokes goreleaser with --snapshot flag"
      pattern: "goreleaser.*snapshot"
    - from: "Makefile"
      to: ".golangci.yml"
      via: "lint target invokes golangci-lint which reads config"
      pattern: "golangci-lint run"
---

<objective>
Create GoReleaser v2 configuration for multi-platform binary builds, golangci-lint configuration for code quality, and update Makefile with lint/snapshot targets.

Purpose: Establish the build and release tooling that automates cross-platform binary production and code quality enforcement. GoReleaser will produce checksummed binaries for 6 platform/arch combinations. golangci-lint will catch code quality issues before they reach CI.

Output: `.goreleaser.yaml`, `.golangci.yml`, updated `Makefile` with `lint` and `snapshot` targets.
</objective>

<execution_context>
@/Users/rnathani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rnathani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .goreleaser.yaml and .golangci.yml configuration files</name>
  <files>.goreleaser.yaml, .golangci.yml</files>
  <action>
Create `.goreleaser.yaml` with GoReleaser v2 format:

```yaml
version: 2

project_name: kubectl-analyze-images

before:
  hooks:
    - go mod tidy

builds:
  - id: kubectl-analyze-images
    main: ./cmd/kubectl-analyze-images
    binary: kubectl-analyze-images
    env:
      - CGO_ENABLED=0
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}

archives:
  - id: default
    format: tar.gz
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    format_overrides:
      - goos: windows
        format: zip

checksum:
  name_template: "checksums.txt"

changelog:
  sort: asc
  filters:
    exclude:
      - "^docs:"
      - "^test:"
      - "^chore:"

release:
  github:
    owner: ronaknnathani
    name: kubectl-analyze-images
  draft: false
  prerelease: auto
  name_template: "{{.ProjectName}} v{{.Version}}"
```

Key design decisions:
- `version: 2` is required for GoReleaser v2
- `CGO_ENABLED=0` ensures static binaries for all platforms
- Binary name is `kubectl-analyze-images` for krew compatibility
- `main: ./cmd/kubectl-analyze-images` points to the correct entry point directory
- ldflags inject `main.version`, `main.commit`, `main.date` matching the vars in main.go
- `-s -w` strips debug info for smaller binaries
- Archives use tar.gz for unix, zip for windows
- Checksums file generated automatically
- Changelog excludes docs/test/chore commits

Create `.golangci.yml` with reasonable linters for a v1.0 project:

```yaml
run:
  timeout: 5m
  go: "1.23"

linters:
  enable:
    - errcheck
    - govet
    - ineffassign
    - staticcheck
    - unused
    - gosimple
    - gocritic
    - gofmt
    - goimports
    - misspell
    - unconvert
    - unparam

linters-settings:
  govet:
    enable-all: true
    disable:
      - fieldalignment
  gocritic:
    enabled-tags:
      - diagnostic
      - style
    disabled-checks:
      - hugeParam
  goimports:
    local-prefixes: github.com/ronaknnathani/kubectl-analyze-images
  misspell:
    locale: US

issues:
  exclude-rules:
    - path: _test\.go
      linters:
        - errcheck
        - unparam
  max-issues-per-linter: 50
  max-same-issues: 10
```

Key design decisions:
- Timeout 5m is generous for CI environments
- Linters chosen are standard, well-established ones that catch real issues without being overly pedantic
- `fieldalignment` disabled in govet because it is noisy and premature optimization
- `hugeParam` disabled in gocritic because our structs are reasonably sized
- Test files exempt from errcheck and unparam since test helpers often ignore errors
- `goimports` configured with local prefix for correct import grouping
- NOT enabling: `exhaustive` (too strict for v1.0), `wrapcheck` (too verbose), `gomnd` (magic number complaints on reasonable constants)
  </action>
  <verify>Verify both files are valid YAML: `python3 -c "import yaml; yaml.safe_load(open('.goreleaser.yaml'))"` and `python3 -c "import yaml; yaml.safe_load(open('.golangci.yml'))"` both succeed. Verify .goreleaser.yaml contains `version: 2`, `binary: kubectl-analyze-images`, and ldflags with `main.version`. Verify .golangci.yml contains `linters:` section with `enable:` list.</verify>
  <done>.goreleaser.yaml exists with GoReleaser v2 config targeting 6 platform/arch combinations (linux/darwin/windows x amd64/arm64), ldflags injecting version/commit/date, CGO_ENABLED=0 for static binaries, checksums enabled. .golangci.yml exists with 13 enabled linters, test file exclusions, and reasonable settings for a v1.0 project.</done>
</task>

<task type="auto">
  <name>Task 2: Update Makefile with lint, snapshot, and improved build targets</name>
  <files>Makefile</files>
  <action>
Update the existing Makefile to add new targets while preserving existing ones. The updated Makefile should have:

**Preserve existing targets:** `build`, `clean`, `test`, `install`, `install-plugin`, `deps`, `run-mock`, `help`

**Update build target** to use ldflags for version injection (matching goreleaser ldflags):

```makefile
VERSION ?= $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
COMMIT ?= $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
DATE ?= $(shell date -u +"%Y-%m-%dT%H:%M:%SZ")
LDFLAGS := -s -w -X main.version=$(VERSION) -X main.commit=$(COMMIT) -X main.date=$(DATE)

build: deps
	go build -ldflags "$(LDFLAGS)" -o kubectl-analyze-images ./cmd/kubectl-analyze-images
```

Note: Changed from `cmd/kubectl-analyze-images/main.go` to `./cmd/kubectl-analyze-images` (directory path) for consistency with goreleaser and Go conventions.

**Add new targets:**

```makefile
# Run linter
lint:
	golangci-lint run ./...

# Run tests with coverage
test-coverage:
	go test -coverprofile=coverage.out ./...
	go tool cover -func=coverage.out

# Local release test (no publish)
snapshot:
	goreleaser release --snapshot --clean

# Run all checks (test + lint)
check: test lint
```

**Update .PHONY** to include all targets:
```makefile
.PHONY: build clean test test-coverage install install-plugin deps run-mock lint snapshot check help
```

**Update help target** to document new targets:
```makefile
help:
	@echo "Available targets:"
	@echo "  build          - Build the plugin with version info"
	@echo "  clean          - Clean build artifacts"
	@echo "  test           - Run tests"
	@echo "  test-coverage  - Run tests with coverage report"
	@echo "  lint           - Run golangci-lint"
	@echo "  check          - Run tests and linter"
	@echo "  snapshot       - Build snapshot release (goreleaser)"
	@echo "  install        - Install to ~/.local/bin"
	@echo "  install-plugin - Install as kubectl plugin"
	@echo "  deps           - Download dependencies"
	@echo "  help           - Show this help"
```

**Remove run-mock from help** since it is a development convenience that does not need prominent listing (keep the target but remove from help output).

**Update clean target** to also clean goreleaser dist and coverage:
```makefile
clean:
	rm -f kubectl-analyze-images
	rm -f coverage.out
	rm -rf dist/
```
  </action>
  <verify>Run `make build` to verify the build target works with ldflags. Check the binary has version info: `./kubectl-analyze-images --version` should show version, commit, and date. Verify `make test` still works. Run `make help` to see all targets listed. Verify Makefile syntax: `make -n lint` should show the golangci-lint command. Verify `make -n snapshot` shows goreleaser command.</verify>
  <done>Makefile updated with: ldflags-based build injecting version/commit/date, `lint` target running golangci-lint, `test-coverage` target generating coverage report, `snapshot` target for local goreleaser testing, `check` target running both test and lint, updated clean target removing dist/ and coverage.out, comprehensive help text. `make build` produces binary with version info. All existing targets preserved.</done>
</task>

</tasks>

<verification>
1. `.goreleaser.yaml` exists and is valid YAML with `version: 2`
2. `.goreleaser.yaml` specifies 6 build targets (3 OS x 2 arch)
3. `.goreleaser.yaml` ldflags match main.go variables (version, commit, date)
4. `.goreleaser.yaml` binary name is `kubectl-analyze-images`
5. `.golangci.yml` exists and is valid YAML with linters enabled
6. `.golangci.yml` excludes test files from errcheck
7. `make build` succeeds and produces binary with version info
8. `make test` passes (no regressions)
9. `make -n lint` shows `golangci-lint run ./...`
10. `make -n snapshot` shows `goreleaser release --snapshot --clean`
11. `./kubectl-analyze-images --version` shows version, commit, and date
</verification>

<success_criteria>
- GoReleaser v2 config targets linux/darwin/windows on amd64/arm64 with correct ldflags
- golangci-lint config enables 13 standard linters with reasonable settings
- Makefile build injects version/commit/date via ldflags
- `make build` produces a working binary with version info
- `make test` passes all existing tests
- New Makefile targets (lint, snapshot, check, test-coverage) are defined and documented
</success_criteria>

<output>
After completion, create `.planning/phases/04-build-release-automation/04-01-SUMMARY.md`
</output>
