---
phase: 01-foundation-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - pkg/util/image.go
  - pkg/util/image_test.go
  - pkg/util/format.go
  - pkg/util/format_test.go
  - pkg/types/analysis.go
  - pkg/types/image.go
  - internal/analyzer/pod_analyzer.go
  - internal/reporter/report.go
  - pkg/types/visualization.go
autonomous: true

must_haves:
  truths:
    - "extractRegistryAndTag exists in exactly one location (pkg/util/image.go)"
    - "formatBytes and formatBytesShort exist in exactly one location (pkg/util/format.go)"
    - "All unused AnalysisConfig fields (Concurrency, Timeout, RetryCount, CacheTTL, CacheDir, EnableCache) are removed"
    - "go test ./pkg/util/... passes with >90% coverage on utility functions"
    - "make build succeeds with zero errors"
  artifacts:
    - path: "pkg/util/image.go"
      provides: "Exported ExtractRegistryAndTag function"
      exports: ["ExtractRegistryAndTag"]
    - path: "pkg/util/format.go"
      provides: "Exported FormatBytes and FormatBytesShort functions"
      exports: ["FormatBytes", "FormatBytesShort"]
    - path: "pkg/util/image_test.go"
      provides: "Table-driven tests for image parsing"
      contains: "TestExtractRegistryAndTag"
    - path: "pkg/util/format_test.go"
      provides: "Table-driven tests for byte formatting"
      contains: "TestFormatBytes"
    - path: "pkg/types/analysis.go"
      provides: "Cleaned AnalysisConfig with only PodPageSize"
  key_links:
    - from: "internal/analyzer/pod_analyzer.go"
      to: "pkg/util/image.go"
      via: "import and call util.ExtractRegistryAndTag"
      pattern: "util\\.ExtractRegistryAndTag"
    - from: "pkg/types/image.go"
      to: "pkg/util/image.go"
      via: "import and call util.ExtractRegistryAndTag"
      pattern: "util\\.ExtractRegistryAndTag"
    - from: "internal/reporter/report.go"
      to: "pkg/util/format.go"
      via: "import and call util.FormatBytes"
      pattern: "util\\.FormatBytes"
    - from: "pkg/types/visualization.go"
      to: "pkg/util/format.go"
      via: "import and call util.FormatBytes and util.FormatBytesShort"
      pattern: "util\\.(FormatBytes|FormatBytesShort)"
---

<objective>
Create shared utility package, eliminate all code duplication, remove unused config fields, add testify dependency, and write comprehensive unit tests for utility functions.

Purpose: Establish the foundational shared code and test infrastructure that all subsequent plans depend on. Deduplication removes maintenance burden and enables single-location testing. Removing dead config fields makes the codebase honest about its capabilities.

Output: `pkg/util/` package with tested utilities, zero duplicate functions, clean AnalysisConfig.
</objective>

<execution_context>
@/Users/rnathani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rnathani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

@go.mod
@pkg/types/analysis.go
@pkg/types/image.go
@pkg/types/visualization.go
@internal/analyzer/pod_analyzer.go
@internal/reporter/report.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared utility package with tests and add testify</name>
  <files>
    go.mod
    go.sum
    pkg/util/image.go
    pkg/util/image_test.go
    pkg/util/format.go
    pkg/util/format_test.go
  </files>
  <action>
1. Add testify as a direct dependency. Run:
   ```
   cd /Users/rnathani/code/go/src/kubectl-analyze-images
   go get github.com/stretchr/testify@v1.9.1
   ```
   This promotes the existing indirect v1.8.4 to a direct v1.9.1.

2. Create `pkg/util/image.go`:
   - Package: `util`
   - Import: `"strings"`
   - Export function `ExtractRegistryAndTag(imageName string) (string, string)` -- exact same logic as the existing `extractRegistryAndTag` in `pkg/types/image.go` (lines 65-83) but with an uppercase exported name.
   - The function splits on "/", defaults to registry="unknown" and tag="latest", extracts registry from parts[0] when len(parts) >= 2, and extracts tag from the last part after ":".

3. Create `pkg/util/format.go`:
   - Package: `util`
   - Import: `"fmt"`
   - Export function `FormatBytes(bytes int64) string` -- exact same logic as in `internal/reporter/report.go` lines 162-173. Uses 1024 unit, returns "X B" for small values, "X.X KB/MB/GB/TB/PB/EB" for larger.
   - Export function `FormatBytesShort(bytes int64) string` -- exact same logic as in `pkg/types/visualization.go` lines 256-267. Like FormatBytes but no space and uses "%.0f" (integer rounding).

4. Create `pkg/util/image_test.go`:
   - Package: `util` (white-box, same package)
   - Import testify/assert
   - Use table-driven tests with at least 12 cases:
     - "docker.io/library/nginx:1.21" -> ("docker.io", "1.21")
     - "gcr.io/project/image:v1.0" -> ("gcr.io", "v1.0")
     - "quay.io/organization/app:latest" -> ("quay.io", "latest")
     - "docker.io/library/nginx" (no tag) -> ("docker.io", "latest")
     - "nginx" (single component) -> ("unknown", "latest")
     - "nginx:1.21" (single with tag) -> ("unknown", "latest")  -- current behavior: len(parts) < 2 returns defaults
     - "" (empty string) -> ("unknown", "latest")
     - "registry.company.com/team/app:v2" -> ("registry.company.com", "v2")
     - "gcr.io/proj/team/service:1.0" (nested path) -> ("gcr.io", "1.0")
     - "docker.io/app:v1.0-alpha" (special chars in tag) -> ("docker.io", "v1.0-alpha")
     - "localhost:5000/app:dev" (port in registry) -> ("localhost:5000", "dev")
     - "docker.io/nginx@sha256:abc123" (digest) -> ("docker.io", "latest") -- no ":" in last part after split by "/"

5. Create `pkg/util/format_test.go`:
   - Package: `util`
   - Import testify/assert
   - Table-driven `TestFormatBytes` with cases:
     - 0 -> "0 B"
     - 500 -> "500 B"
     - 1023 -> "1023 B"
     - 1024 -> "1.0 KB"
     - 1536 -> "1.5 KB"
     - 1048576 -> "1.0 MB"
     - 1073741824 -> "1.0 GB"
     - 1099511627776 -> "1.0 TB"
   - Table-driven `TestFormatBytesShort` with cases:
     - 0 -> "0B"
     - 500 -> "500B"
     - 1024 -> "1K"
     - 1048576 -> "1M"
     - 1073741824 -> "1G"

6. Run `go mod tidy` to finalize go.sum.
  </action>
  <verify>
Run these commands and confirm all pass:
```
cd /Users/rnathani/code/go/src/kubectl-analyze-images
go test ./pkg/util/... -v -count=1
go test ./pkg/util/... -cover
go list -m github.com/stretchr/testify
```
Expected: All tests pass, coverage >90% for pkg/util, testify v1.9.1 listed.
  </verify>
  <done>
- `pkg/util/image.go` exports `ExtractRegistryAndTag`
- `pkg/util/format.go` exports `FormatBytes` and `FormatBytesShort`
- At least 12 image parsing test cases and 10+ format test cases pass
- testify v1.9.1 appears as direct dependency in go.mod
  </done>
</task>

<task type="auto">
  <name>Task 2: Eliminate duplication and remove unused config fields</name>
  <files>
    internal/analyzer/pod_analyzer.go
    pkg/types/image.go
    internal/reporter/report.go
    pkg/types/visualization.go
    pkg/types/analysis.go
  </files>
  <action>
1. Update `internal/analyzer/pod_analyzer.go`:
   - Add import: `"github.com/ronaknnathani/kubectl-analyze-images/pkg/util"`
   - Replace both calls to `extractRegistryAndTag(imageName)` (lines 104 and 114) with `util.ExtractRegistryAndTag(imageName)`
   - DELETE the entire `extractRegistryAndTag` function definition (lines 149-168)
   - Remove `"strings"` from imports if no longer used (check: strings.Split is only used in extractRegistryAndTag, so it should be removable)

2. Update `pkg/types/image.go`:
   - Add import: `"github.com/ronaknnathani/kubectl-analyze-images/pkg/util"`
   - In `NewInaccessibleImage` (line 54), replace `extractRegistryAndTag(imageName)` with `util.ExtractRegistryAndTag(imageName)`
   - DELETE the entire `extractRegistryAndTag` function definition (lines 64-83)
   - Remove `"strings"` from imports (only used by deleted function)

3. Update `internal/reporter/report.go`:
   - Add import: `"github.com/ronaknnathani/kubectl-analyze-images/pkg/util"`
   - Replace both calls to `formatBytes(...)` (lines 88 and 118) with `util.FormatBytes(...)`
   - DELETE the entire `formatBytes` function definition (lines 161-173)

4. Update `pkg/types/visualization.go`:
   - Add import: `"github.com/ronaknnathani/kubectl-analyze-images/pkg/util"`
   - In `RenderASCII`, replace ALL calls to `formatBytes(...)` (lines 210, 211, 212, 244-248) with `util.FormatBytes(...)`
   - Replace ALL calls to `formatBytesShort(...)` (line 171, two calls) with `util.FormatBytesShort(...)`
   - DELETE the `formatBytesShort` function definition (lines 255-267)
   - DELETE the `formatBytes` function definition (lines 269-281)

5. Update `pkg/types/analysis.go`:
   - Remove the `"time"` import (only used by deleted fields)
   - Replace the `AnalysisConfig` struct with ONLY the `PodPageSize` field:
     ```go
     type AnalysisConfig struct {
         PodPageSize int64 // Number of pods to fetch per page
     }
     ```
   - Update `DefaultAnalysisConfig()` to return only:
     ```go
     return &AnalysisConfig{
         PodPageSize: 500,
     }
     ```
   - Leave `PerformanceMetrics` struct unchanged.
  </action>
  <verify>
Run these commands and confirm all pass:
```
cd /Users/rnathani/code/go/src/kubectl-analyze-images
make build
go test ./...
go vet ./...
```

Verify deduplication with:
```
grep -rn "func extractRegistryAndTag" --include="*.go" .
# Expected: ONLY pkg/util/image.go

grep -rn "func formatBytes" --include="*.go" .
# Expected: ONLY pkg/util/format.go (both FormatBytes and FormatBytesShort)

grep -rn "Concurrency\|RetryCount\|CacheTTL\|CacheDir\|EnableCache" pkg/types/analysis.go
# Expected: 0 results
```
  </verify>
  <done>
- `extractRegistryAndTag` exists in exactly ONE location: `pkg/util/image.go`
- `formatBytes` exists in exactly ONE location: `pkg/util/format.go`
- `formatBytesShort` exists in exactly ONE location: `pkg/util/format.go`
- All 6 unused AnalysisConfig fields removed (Concurrency, Timeout, RetryCount, CacheTTL, CacheDir, EnableCache)
- `make build` succeeds
- `go test ./...` passes (all existing functionality preserved)
- `go vet ./...` reports no issues
  </done>
</task>

</tasks>

<verification>
1. `make build` produces binary without errors
2. `go test ./... -v` -- all tests pass
3. `go test ./... -cover` -- pkg/util shows >90% coverage
4. `grep -rn "func extractRegistryAndTag" --include="*.go" .` returns exactly 1 result (pkg/util/image.go)
5. `grep -rn "func formatBytes\b" --include="*.go" .` returns exactly 1 result (pkg/util/format.go)
6. `grep -rn "func FormatBytesShort\b" --include="*.go" .` returns exactly 1 result (pkg/util/format.go)
7. `grep -rn "Concurrency\|RetryCount\|CacheTTL" --include="*.go" pkg/types/analysis.go` returns 0 results
8. `go vet ./...` passes
</verification>

<success_criteria>
- Zero code duplication for image parsing and byte formatting
- Shared utility package exists with exported, tested functions
- testify v1.9.1 is a direct dependency
- AnalysisConfig contains only PodPageSize
- Build and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-testing-infrastructure/01-01-SUMMARY.md`
</output>
