---
phase: 01-foundation-testing-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - pkg/types/printer.go
  - internal/reporter/table_printer.go
  - internal/reporter/table_printer_test.go
  - internal/reporter/json_printer.go
  - internal/reporter/json_printer_test.go
  - internal/reporter/report.go
  - cmd/kubectl-analyze-images/main.go
autonomous: true

must_haves:
  truths:
    - "Printer interface is defined with Print(w io.Writer, analysis *ImageAnalysis) error"
    - "Table output writes to an io.Writer, not directly to os.Stdout"
    - "JSON output writes to an io.Writer, not directly to os.Stdout"
    - "Existing CLI behavior is preserved (table and JSON output unchanged)"
    - "go test ./internal/reporter/... passes with >70% coverage"
    - "go test ./... passes and total coverage exceeds 30%"
  artifacts:
    - path: "pkg/types/printer.go"
      provides: "Printer interface definition"
      contains: "type Printer interface"
    - path: "internal/reporter/table_printer.go"
      provides: "TablePrinter struct implementing Printer"
      exports: ["NewTablePrinter"]
    - path: "internal/reporter/json_printer.go"
      provides: "JSONPrinter struct implementing Printer"
      exports: ["NewJSONPrinter"]
    - path: "internal/reporter/table_printer_test.go"
      provides: "Table printer tests using bytes.Buffer"
      contains: "TestTablePrinter"
    - path: "internal/reporter/json_printer_test.go"
      provides: "JSON printer tests using bytes.Buffer"
      contains: "TestJSONPrinter"
  key_links:
    - from: "internal/reporter/table_printer.go"
      to: "pkg/types/printer.go"
      via: "implements Printer interface"
      pattern: "func.*TablePrinter.*Print.*io\\.Writer"
    - from: "internal/reporter/json_printer.go"
      to: "pkg/types/printer.go"
      via: "implements Printer interface"
      pattern: "func.*JSONPrinter.*Print.*io\\.Writer"
    - from: "cmd/kubectl-analyze-images/main.go"
      to: "internal/reporter"
      via: "creates printer and calls Print(os.Stdout, analysis)"
      pattern: "printer\\.Print\\(os\\.Stdout"
    - from: "internal/reporter/table_printer.go"
      to: "pkg/util/format.go"
      via: "uses util.FormatBytes for size formatting"
      pattern: "util\\.FormatBytes"
---

<objective>
Create Printer interface abstraction, extract table and JSON formatters into testable implementations, and write comprehensive tests for both printers using bytes.Buffer.

Purpose: Make output formatting testable and extensible. The current Reporter prints directly to os.Stdout, making it impossible to unit test output content. The Printer interface with io.Writer injection enables buffer-based testing and future format additions (YAML, CSV).

Output: Printer interface, TablePrinter, JSONPrinter with full test suites. Reporter simplified to a thin wrapper. Total project test coverage >30%.
</objective>

<execution_context>
@/Users/rnathani/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rnathani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-testing-infrastructure/01-01-SUMMARY.md

@internal/reporter/report.go
@cmd/kubectl-analyze-images/main.go
@pkg/types/image.go
@pkg/types/visualization.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Printer interface and extract table/JSON printers</name>
  <files>
    pkg/types/printer.go
    internal/reporter/table_printer.go
    internal/reporter/json_printer.go
    internal/reporter/report.go
    cmd/kubectl-analyze-images/main.go
  </files>
  <action>
1. Create `pkg/types/printer.go`:
   ```go
   package types

   import "io"

   // Printer defines the interface for output formatters.
   // Implementations write analysis results to the provided writer.
   type Printer interface {
       Print(w io.Writer, analysis *ImageAnalysis) error
   }
   ```

2. Create `internal/reporter/table_printer.go`:
   - Package: `reporter`
   - Struct `TablePrinter` with fields: `showHistogram bool`, `noColor bool`, `topImages int`
   - Constructor: `func NewTablePrinter(showHistogram, noColor bool, topImages int) *TablePrinter`
   - Method: `func (tp *TablePrinter) Print(w io.Writer, analysis *types.ImageAnalysis) error`
   - Extract the table formatting logic from the current `generateTableReport` method in report.go.
   - CRITICAL CHANGE: Replace ALL `os.Stdout` references with the `w io.Writer` parameter:
     - `tablewriter.NewWriter(os.Stdout)` becomes `tablewriter.NewWriter(w)`
     - `fmt.Println(...)` becomes `fmt.Fprintln(w, ...)`
     - `fmt.Printf(...)` becomes `fmt.Fprintf(w, ...)`
     - `fmt.Print(...)` becomes `fmt.Fprint(w, ...)`
   - Import `pkg/util` for `util.FormatBytes` (from Plan 01).
   - Keep the same output structure: Performance Summary table, Image Analysis Summary table, Histogram (if showHistogram && images exist), Top N Images table.

3. Create `internal/reporter/json_printer.go`:
   - Package: `reporter`
   - Struct `JSONPrinter` with no fields (stateless)
   - Constructor: `func NewJSONPrinter() *JSONPrinter`
   - Method: `func (jp *JSONPrinter) Print(w io.Writer, analysis *types.ImageAnalysis) error`
   - Extract the JSON formatting logic from the current `generateJSONReport` method in report.go.
   - Use `json.NewEncoder(w).Encode(...)` with `SetIndent("", "  ")` to write to the writer instead of marshaling to string and printing.
   - Keep the same JSON structure: `{ performance, summary: { totalImages, totalSize, uniqueSize }, images }`.

4. Refactor `internal/reporter/report.go`:
   - Keep the `Reporter` struct and its constructor/setters for backward compatibility (they are still used by main.go).
   - Change `GenerateReport` to create the appropriate printer and delegate:
     ```go
     func (r *Reporter) GenerateReport(analysis *types.ImageAnalysis) error {
         var printer types.Printer
         switch r.outputFormat {
         case "table":
             printer = NewTablePrinter(r.showHistogram, r.noColor, r.topImages)
         case "json":
             printer = NewJSONPrinter()
         default:
             return fmt.Errorf("unsupported output format: %s", r.outputFormat)
         }
         return printer.Print(os.Stdout, analysis)
     }
     ```
   - DELETE the `generateTableReport` method (moved to table_printer.go).
   - DELETE the `generateJSONReport` method (moved to json_printer.go).
   - DELETE the `formatBytes` function if it still exists (should already be gone from Plan 01, but verify).
   - The `Reporter` struct becomes a thin factory/facade. Keep it for now; Phase 3 will refactor main.go to use printers directly.

5. Update `cmd/kubectl-analyze-images/main.go`:
   - No structural changes needed in this plan. The Reporter facade still works.
   - If Plan 01 changed `DefaultAnalysisConfig()` return shape, verify main.go compiles (it should, since it only calls `DefaultAnalysisConfig()` without accessing removed fields).
  </action>
  <verify>
Run:
```
cd /Users/rnathani/code/go/src/kubectl-analyze-images
make build
go vet ./...
```
Both must pass. The binary should produce identical output to before (existing CLI behavior preserved).
  </verify>
  <done>
- `Printer` interface defined in `pkg/types/printer.go`
- `TablePrinter` in `internal/reporter/table_printer.go` writes to `io.Writer`
- `JSONPrinter` in `internal/reporter/json_printer.go` writes to `io.Writer`
- `report.go` delegates to printers instead of containing formatting logic
- `make build` succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive tests for table and JSON printers</name>
  <files>
    internal/reporter/table_printer_test.go
    internal/reporter/json_printer_test.go
  </files>
  <action>
1. Create `internal/reporter/table_printer_test.go`:
   - Package: `reporter` (white-box testing for access to internals)
   - Import: `bytes`, `testing`, `time`, `github.com/stretchr/testify/assert`, `github.com/stretchr/testify/require`, `types` package
   - Write `TestTablePrinter_Print` as table-driven test with cases:

     **Case "basic output with images":**
     - Input: ImageAnalysis with 2 images (nginx:1.21 at 133000000 bytes, redis:6.2 at 110000000 bytes), TotalSize=243000000, Performance with ImagesProcessed=2 and TotalTime=1500ms
     - Assert output contains: "Performance Summary", "Image Analysis Summary", "nginx:1.21", "redis:6.2", "Total Images"
     - Assert no error

     **Case "empty analysis":**
     - Input: ImageAnalysis with empty Images slice, nil Performance
     - Assert output contains: "Image Analysis Summary", "Total Images"
     - Assert output does NOT contain: "Performance Summary" (because Performance is nil)
     - Assert no error

     **Case "inaccessible images":**
     - Input: ImageAnalysis with one image where Inaccessible=true
     - Assert output contains: "INACCESSIBLE"
     - Assert no error

     **Case "histogram disabled":**
     - Create printer with showHistogram=false
     - Input: ImageAnalysis with images
     - Assert output does NOT contain: "Image Size Distribution"

     **Case "histogram enabled with images":**
     - Create printer with showHistogram=true, noColor=true (to avoid ANSI codes in test output)
     - Input: ImageAnalysis with at least 3 images of varying sizes
     - Assert output contains: "Image Size Distribution"

   - All tests use `var buf bytes.Buffer` and call `printer.Print(&buf, analysis)`
   - Parse output from `buf.String()`

2. Create `internal/reporter/json_printer_test.go`:
   - Package: `reporter`
   - Import: `bytes`, `encoding/json`, `testing`, `testify/assert`, `testify/require`, `types` package
   - Write `TestJSONPrinter_Print` with cases:

     **Case "valid JSON structure":**
     - Input: ImageAnalysis with 2 images, TotalSize=243000000, UniqueSize=200000000
     - Write to buffer, then `json.Unmarshal` the buffer bytes
     - Assert: unmarshal succeeds (valid JSON)
     - Assert: result has "images" key with array length 2
     - Assert: result has "summary" key with "totalImages"=2, "totalSize"=243000000, "uniqueSize"=200000000

     **Case "empty images produces valid JSON":**
     - Input: ImageAnalysis with empty Images slice
     - Assert: valid JSON, images array is empty or null, totalImages=0

     **Case "performance metrics included":**
     - Input: ImageAnalysis with Performance set (ImagesProcessed=5, TotalTime=2s)
     - Assert: result has "performance" key that is not null
     - Assert: performance has "ImagesProcessed" field

     **Case "no performance when nil":**
     - Input: ImageAnalysis with Performance=nil
     - Assert: result either has no "performance" key or it is null (omitempty behavior)

   - All tests use `var buf bytes.Buffer` and call `printer.Print(&buf, analysis)`

3. Run full test suite and check coverage:
   ```
   go test ./... -v -count=1
   go test ./... -cover
   go test ./internal/reporter/... -cover
   ```
  </action>
  <verify>
Run:
```
cd /Users/rnathani/code/go/src/kubectl-analyze-images
go test ./... -v -count=1
go test ./... -cover
go test ./internal/reporter/... -coverprofile=reporter_cover.out
go tool cover -func=reporter_cover.out
```
Expected:
- All tests pass
- `internal/reporter` package coverage >70%
- Overall project coverage >30% (combined pkg/util + internal/reporter)
  </verify>
  <done>
- `table_printer_test.go` has at least 5 test cases covering basic output, empty input, inaccessible images, histogram on/off
- `json_printer_test.go` has at least 4 test cases covering JSON structure, empty input, performance presence/absence
- All tests pass
- Reporter package coverage >70%
- Total project coverage >30% (as measured by `go test ./... -cover`)
  </done>
</task>

</tasks>

<verification>
1. `make build` produces binary without errors
2. `go test ./... -v -count=1` -- all tests pass (both pkg/util and internal/reporter)
3. `go test ./... -cover` -- total coverage >30%
4. `go test ./internal/reporter/... -cover` -- reporter coverage >70%
5. `go vet ./...` -- no issues
6. Printer interface exists: `grep "type Printer interface" pkg/types/printer.go`
7. Table printer writes to writer: `grep "io.Writer" internal/reporter/table_printer.go`
8. JSON printer writes to writer: `grep "io.Writer" internal/reporter/json_printer.go`
9. Report.go no longer contains generateTableReport or generateJSONReport methods
</verification>

<success_criteria>
- Printer interface abstraction enables buffer-based testing
- Table and JSON printers have comprehensive test suites
- Reporter package coverage >70%
- Total project test coverage >30%
- Build succeeds and existing CLI behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-testing-infrastructure/01-02-SUMMARY.md`
</output>
